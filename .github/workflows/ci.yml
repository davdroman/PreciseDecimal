name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  macos:
    name: macOS - ${{ matrix.platform.name }}
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        platform:
          - { name: 'iOS 14.5',     destination: "'platform=iOS Simulator,name=iPhone 8,OS=14.5'" }
          - { name: 'macOS Latest', destination: "'platform=macOS,arch=x86_64'" }

    steps:
      - name: Install xcbeautify
        run: brew install xcbeautify
      - name: Checkout
        uses: actions/checkout@v1
      - name: Build and Test
        run: |
          NSUnbufferedIO=YES \
          xcodebuild clean test \
            -destination ${{ matrix.platform.destination }} \
            -scheme PreciseDecimal \
            2>&1 | xcbeautify

  linux:
    name: Linux - ${{ matrix.swift.name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        swift:
          - { name: 'Swift 5.1',    image: '5.1' }
          - { name: 'Swift 5.2',    image: '5.2' }
          - { name: 'Swift 5.3',    image: '5.3' }
          - { name: 'Swift 5.4',    image: '5.4' }
          - { name: 'Swift Latest', image: 'latest' }

    container:
      image: swift:${{ matrix.swift.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build and Test
        run: swift test --enable-test-discovery
